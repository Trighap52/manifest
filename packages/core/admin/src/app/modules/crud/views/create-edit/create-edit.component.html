<ng-container *ngIf="entityManifest">
  <section>
    <div
      class="is-flex is-justify-content-space-between is-align-items-center mb-5"
    >
      <div class="left-part">
        <h1 class="title is-2 has-text-weight-light">
          <ng-container *ngIf="edit">
            <ng-container *ngIf="singleMode"
              >Edit {{ entityManifest.nameSingular }}</ng-container
            >
            <ng-container *ngIf="!singleMode"
              >Edit an existing {{ entityManifest.nameSingular }}</ng-container
            >
          </ng-container>
          <ng-container *ngIf="!edit">
            Create a new {{ entityManifest.nameSingular }}
          </ng-container>
        </h1>
      </div>
      <div class="right-part">
        <button
          class="button is-link is-hidden-touch"
          [ngClass]="{ 'is-loading': loading }"
          type="submit"
          (click)="submit()"
        >
          Submit
        </button>
        <button
          class="button is-link is-hidden-desktop is-circle"
          [ngClass]="{ 'is-loading': loading }"
          type="submit"
          (click)="submit()"
        >
          <i class="icon icon-save"></i>
        </button>
      </div>
    </div>

    <form [formGroup]="form" *ngIf="item || !edit">
      <div class="card is-shadowless p-4">
        <div class="columns">
          <div
            class="column is-12-touch is-8-desktop is-offset-2-desktop is-6-widescreen is-offset-3-widescreen is-6-fullhd is-offset-3-fullhd"
          >
            <div class="form-group">
              <div
                class="field mt-2 mb-4"
                *ngFor="let prop of entityManifest.properties"
              >
                <div class="control">
                  <app-input
                    [prop]="prop"
                    [entityManifest]="entityManifest"
                    [value]="edit ? item[prop.name] : null"
                    [errors]="errors[prop.name]"
                    (valueChanged)="
                      onChange({
                        propName: prop.name,
                        newValue: $event
                      })
                    "
                  ></app-input>
                </div>
              </div>

              <!-- Relations -->
              <div
                class="field mt-2 mb-4"
                *ngFor="let relationship of entityManifest.relationships"
              >
                <div
                  class="control"
                  *ngIf="
                    relationship.type === 'many-to-one' ||
                    (relationship.type === 'many-to-many' &&
                      relationship.owningSide)
                  "
                >
                  <app-input
                    [relationship]="relationship"
                    [value]="edit ? item[relationship.name] : null"
                    [errors]="errors[relationship.name]"
                    (valueChanged)="
                      onRelationChange({
                        relationship,
                        newValue: $event
                      })
                    "
                  ></app-input>
                </div>
              </div>

              <!-- Groups (nested relations) -->
              <div
                class="field mt-2 mb-4"
                *ngFor="let relationship of entityManifest.relationships"
              >
                <div class="control" *ngIf="relationship.nested">
                  <h2 class="title is-2">{{ relationship.name }}</h2>

                  <!-- Display help text if available -->
                  <p class="help" *ngIf="relationship.helpText">
                    {{ relationship.helpText }}
                  </p>

                  <button
                    class="button is-primary is-small"
                    type="button"
                    (click)="addNestedItem(relationship)"
                    *ngIf="
                      relationship.type !== 'one-to-one' ||
                      getSingleRelation(relationship.name) === null
                    "
                  >
                    <span class="icon is-small">
                      <i class="icon icon-plus"></i>-
                    </span>
                    <span>Add {{ relationship.entity }}</span>
                  </button>

                  <!-- Nested relations (single) -->
                  <ng-container *ngIf="relationship.type === 'one-to-one'">
                    <p *ngIf="!form.get(relationship.name)?.value">
                      No {{ relationship.name }} added yet. Click on "Add
                      {{ relationship.entity }}" to create a new item.
                    </p>

                    <div
                      class="card nested-item"
                      *ngIf="getSingleRelation(relationship.name)"
                    >
                      <button
                        class="delete is-small"
                        type="button"
                        (click)="removeSingleNestedItem(relationship)"
                      ></button>
                      <div
                        *ngFor="
                          let prop of nestedEntityManifests[relationship.name]
                            .properties
                        "
                      >
                        <div class="control">
                          <app-input
                            [prop]="prop"
                            [entityManifest]="entityManifest"
                            [value]="
                              edit
                                ? getSingleRelation(relationship.name).get(
                                    prop.name
                                  )?.value
                                : null
                            "
                            [errors]="
                              errors[relationship.name + '.' + prop.name]
                            "
                            (valueChanged)="
                              onNestedItemChange({
                                relationship,
                                propName: prop.name,
                                newValue: $event
                              })
                            "
                          ></app-input>
                        </div>
                      </div>
                    </div>
                  </ng-container>

                  <!-- Nested relations (multiple) -->
                  <ng-container *ngIf="relationship.type !== 'one-to-one'">
                    <p
                      *ngIf="
                        getMultipleRelations(relationship.name).length === 0
                      "
                    >
                      No {{ relationship.name }} added yet. Click on "Add
                      {{ relationship.entity }}" to create a new item.
                    </p>

                    <div
                      class="card nested-item"
                      *ngFor="
                        let nestedItem of getMultipleRelations(
                          relationship.name
                        ).controls;
                        let i = index
                      "
                    >
                      <button
                        class="delete is-small"
                        type="button"
                        (click)="removeNestedItem(relationship, i)"
                      ></button>
                      <div
                        *ngFor="
                          let prop of nestedEntityManifests[relationship.name]
                            .properties
                        "
                      >
                        <div class="control">
                          <app-input
                            [prop]="prop"
                            [entityManifest]="entityManifest"
                            [value]="
                              edit ? nestedItem.get(prop.name)?.value : null
                            "
                            [errors]="
                              errors[
                                relationship.name + '[' + i + '].' + prop.name
                              ]
                            "
                            (valueChanged)="
                              onNestedItemChange({
                                relationship,
                                propName: prop.name,
                                index: i,
                                newValue: $event
                              })
                            "
                          ></app-input>
                        </div>
                      </div>
                    </div>
                  </ng-container>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </form>
  </section>
</ng-container>
